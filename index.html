
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Sifei API Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}      
      .light + pre .hll { background-color: #49483e }
.light + pre .c { color: #75715e } /* Comment */
.light + pre .err { color: #960050; background-color: #1e0010 } /* Error */
.light + pre .k { color: #66d9ef } /* Keyword */
.light + pre .l { color: #ae81ff } /* Literal */
.light + pre .n { color: #f8f8f2 } /* Name */
.light + pre .o { color: #f92672 } /* Operator */
.light + pre .p { color: #f8f8f2 } /* Punctuation */
.light + pre .ch { color: #75715e } /* Comment.Hashbang */
.light + pre .cm { color: #75715e } /* Comment.Multiline */
.light + pre .cp { color: #75715e } /* Comment.Preproc */
.light + pre .cpf { color: #75715e } /* Comment.PreprocFile */
.light + pre .c1 { color: #75715e } /* Comment.Single */
.light + pre .cs { color: #75715e } /* Comment.Special */
.light + pre .gd { color: #f92672 } /* Generic.Deleted */
.light + pre .ge { font-style: italic } /* Generic.Emph */
.light + pre .gi { color: #a6e22e } /* Generic.Inserted */
.light + pre .gs { font-weight: bold } /* Generic.Strong */
.light + pre .gu { color: #75715e } /* Generic.Subheading */
.light + pre .kc { color: #66d9ef } /* Keyword.Constant */
.light + pre .kd { color: #66d9ef } /* Keyword.Declaration */
.light + pre .kn { color: #f92672 } /* Keyword.Namespace */
.light + pre .kp { color: #66d9ef } /* Keyword.Pseudo */
.light + pre .kr { color: #66d9ef } /* Keyword.Reserved */
.light + pre .kt { color: #66d9ef } /* Keyword.Type */
.light + pre .ld { color: #e6db74 } /* Literal.Date */
.light + pre .m { color: #ae81ff } /* Literal.Number */
.light + pre .s { color: rgb(223, 154, 6) } /* Literal.String */
.light + pre .na { color: #0096d2 } /* Name.Attribute */
.light + pre .nb { color: #f8f8f2 } /* Name.Builtin */
.light + pre .nc { color: #a6e22e } /* Name.Class */
.light + pre .no { color: #66d9ef } /* Name.Constant */
.light + pre .nd { color: #a6e22e } /* Name.Decorator */
.light + pre .ni { color: #f8f8f2 } /* Name.Entity */
.light + pre .ne { color: #a6e22e } /* Name.Exception */
.light + pre .nf { color: #a6e22e } /* Name.Function */
.light + pre .nl { color: #f8f8f2 } /* Name.Label */
.light + pre .nn { color: #f8f8f2 } /* Name.Namespace */
.light + pre .nx { color: #a6e22e } /* Name.Other */
.light + pre .py { color: #f8f8f2 } /* Name.Property */
.light + pre .nt { color: #f92672 } /* Name.Tag */
.light + pre .nv { color: #f8f8f2 } /* Name.Variable */
.light + pre .ow { color: #f92672 } /* Operator.Word */
.light + pre .w { color: #f8f8f2 } /* Text.Whitespace */
.light + pre .mb { color: #ae81ff } /* Literal.Number.Bin */
.light + pre .mf { color: #ae81ff } /* Literal.Number.Float */
.light + pre .mh { color: #ae81ff } /* Literal.Number.Hex */
.light + pre .mi { color: #ae81ff } /* Literal.Number.Integer */
.light + pre .mo { color: #ae81ff } /* Literal.Number.Oct */
.light + pre .sa { color: #e6db74 } /* Literal.String.Affix */
.light + pre .sb { color: #e6db74 } /* Literal.String.Backtick */
.light + pre .sc { color: #e6db74 } /* Literal.String.Char */
.light + pre .dl { color: #e6db74 } /* Literal.String.Delimiter */
.light + pre .sd { color: #e6db74 } /* Literal.String.Doc */
.light + pre .s2 { color: #e6db74 } /* Literal.String.Double */
.light + pre .se { color: #ae81ff } /* Literal.String.Escape */
.light + pre .sh { color: #e6db74 } /* Literal.String.Heredoc */
.light + pre .si { color: #e6db74 } /* Literal.String.Interpol */
.light + pre .sx { color: #e6db74 } /* Literal.String.Other */
.light + pre .sr { color: #e6db74 } /* Literal.String.Regex */
.light + pre .s1 { color: #e6db74 } /* Literal.String.Single */
.light + pre .ss { color: #e6db74 } /* Literal.String.Symbol */
.light + pre .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
.light + pre .fm { color: #a6e22e } /* Name.Function.Magic */
.light + pre .vc { color: #f8f8f2 } /* Name.Variable.Class */
.light + pre .vg { color: #f8f8f2 } /* Name.Variable.Global */
.light + pre .vi { color: #f8f8f2 } /* Name.Variable.Instance */
.light + pre .vm { color: #f8f8f2 } /* Name.Variable.Magic */
.light + pre .il { color: #ae81ff } /* Literal.Number.Integer.Long */
    </style>
    <link href="stylesheets/screen-cbd4371b.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print-bccf8c07.css" rel="stylesheet" media="print" />
      <script src="javascripts/all-b2399aee.js"></script>
  </head>

  <body class="index" data-languages="[&quot;php&quot;,&quot;ruby&quot;,&quot;python&quot;,&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar-cad8cdcb.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo-8eff4397.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="php">php</a>
              <a href="#" data-language-name="ruby">ruby</a>
              <a href="#" data-language-name="python">python</a>
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Buscar">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#introduccion" class="toc-h1 toc-link" data-title="Introducci贸n">Introducci贸n</a>
          </li>
          <li>
            <a href="#autenticacion" class="toc-h1 toc-link" data-title="Autenticacion">Autenticacion</a>
          </li>
          <li>
            <a href="#timbrado" class="toc-h1 toc-link" data-title="Timbrado">Timbrado</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#timbrado-getcfdi" class="toc-h2 toc-link" data-title="Timbrado(getCFDI):">Timbrado(getCFDI):</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#url-de-timbrado" class="toc-h3 toc-link" data-title="URL de timbrado">URL de timbrado</a>
                          </li>
                          <li>
                            <a href="#parametros-de-la-solicitud" class="toc-h3 toc-link" data-title="Parametros de la solicitud">Parametros de la solicitud</a>
                          </li>
                          <li>
                            <a href="#excepcion" class="toc-h3 toc-link" data-title="Excepci贸n">Excepci贸n</a>
                          </li>
                          <li>
                            <a href="#codigos-de-error" class="toc-h3 toc-link" data-title="Codigos de error">Codigos de error</a>
                          </li>
                      </ul>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#cancelacion" class="toc-h1 toc-link" data-title="Cancelacion">Cancelacion</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#cancelar-cfdi-cancelacfdi" class="toc-h2 toc-link" data-title="Cancelar CFDI (cancelaCFDI):">Cancelar CFDI (cancelaCFDI):</a>
                  </li>
                  <li>
                    <a href="#getcfdiprocesa" class="toc-h2 toc-link" data-title="getCFDIProcesa">getCFDIProcesa</a>
                  </li>
                  <li>
                    <a href="#codigos-de-error" class="toc-h2 toc-link" data-title="codigos de error">codigos de error</a>
                  </li>
              </ul>
          </li>
      </ul>
        <ul class="toc-footer">
            <li><a href='https://www.sifei.com.mx/'>Sifei</a></li>
            <li><a href='#'>Adquiere tus accesos</a></li>
            <li><a href='https://github.com/slatedocs/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduccion'>Introducci贸n</h1>
<p>Bienvenido a Sifei Docs! Puedes utilizar nuestros servicios para timbrar, cancelar recuperar tus CFDI  ademas de muchas mas otras funciones.</p>

<p>Contamos con ejemplos en Java, C# ,PHP,Ruby, Python, y JavaScript(nodeJs)! Puedes ver el coidigo de ejemplo en el lado derecho y cambiar al langueje de tu interes.
Si necesitas algun ejemplo en algun otro lenguaje favor de solicitarlo.</p>
<h1 id='autenticacion'>Autenticacion</h1>
<p>Para autenticar es necesario que adquieras tus credenciales de ambiente de pruebas.</p>

<p>Aqui hay que describir en una tabla o lista el nombre de usuario, pass y id de equipo</p>

<p>Ademas del proceso para obtener estas</p>

<aside class="notice">
You must replace <code>meowmeowmeow</code> with your personal API key.
</aside>
<h1 id='timbrado'>Timbrado</h1><h2 id='timbrado-getcfdi'>Timbrado(getCFDI):</h2><pre class="highlight ruby tab-ruby"><code><span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'savon'</span>
<span class="nb">require</span> <span class="s1">'iniparse'</span>
<span class="nb">require</span> <span class="s1">'time'</span>
<span class="nb">require</span> <span class="s2">"base64"</span>
<span class="nb">require</span> <span class="s1">'zip'</span>

<span class="n">config</span><span class="o">=</span><span class="no">IniParse</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'config.ini'</span><span class="p">)</span> <span class="p">)</span>

<span class="nb">print</span> <span class="n">config</span>
<span class="nb">print</span> <span class="s2">"hel"</span>

<span class="n">usuario</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">'timbrado'</span><span class="p">][</span><span class="s1">'UsuarioSIFEI'</span><span class="p">]</span>
<span class="n">password</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">'timbrado'</span><span class="p">][</span><span class="s1">'PasswordSIFEI'</span><span class="p">]</span>
<span class="n">idEquipo</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">'timbrado'</span><span class="p">][</span><span class="s1">'IdEquipoGenerado'</span><span class="p">]</span>
<span class="n">usuario</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">'timbrado'</span><span class="p">][</span><span class="s1">'UsuarioSIFEI'</span><span class="p">]</span>

<span class="c1">#file=File.open('xml_sellado.xml','r');</span>
<span class="c1">#cfdi_contenido=file.read</span>
<span class="n">cfdi_contenido</span><span class="o">=</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'assets/xml_sellado.xml'</span><span class="p">)</span>

<span class="c1">#savon 2 no ofrece una manera directa de acceder al request por lo que deberas de utilizar algun interceptor</span>
<span class="n">client</span> <span class="o">=</span> <span class="no">Savon</span><span class="p">.</span><span class="nf">client</span><span class="p">(</span><span class="ss">wsdl: </span><span class="s1">'http://devcfdi.sifei.com.mx:8080/SIFEI33/SIFEI?wsdl'</span><span class="p">,</span>
    <span class="c1">#log: true</span>
    <span class="ss">convert_request_keys_to: :none</span><span class="p">,</span>
    <span class="ss">open_timeout: </span><span class="mi">300</span><span class="p">,</span>
    <span class="ss">read_timeout: </span><span class="mi">300</span><span class="p">,</span>
    <span class="p">)</span>
<span class="c1">#print client.operations</span>
<span class="k">begin</span>
    <span class="c1">#Establecemos el hash(dictionario) con los datos a utilizar!</span>
    <span class="n">soapParams</span><span class="o">=</span> <span class="p">{</span> 
        <span class="no">Usuario</span><span class="p">:</span> <span class="n">usuario</span><span class="p">,</span>
        <span class="no">Password</span><span class="ss">:password</span> <span class="p">,</span>
        <span class="no">IdEquipo</span><span class="p">:</span> <span class="n">idEquipo</span><span class="p">,</span>
        <span class="ss">archivoXMLZip: </span><span class="no">Base64</span><span class="p">.</span><span class="nf">strict_encode64</span><span class="p">(</span><span class="n">cfdi_contenido</span><span class="p">),</span> <span class="c1"># </span>
        <span class="no">Serie</span><span class="ss">:""</span> <span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">#print soapParams</span>
    <span class="c1">#simulamos request para guardarlo y ver como se envia(omitir en produccion)</span>
    <span class="n">operation</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="nf">operation</span><span class="p">(</span><span class="ss">:get_cfdi</span><span class="p">)</span>
    <span class="n">request</span><span class="o">=</span> <span class="n">operation</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">message</span><span class="ss">:soapParams</span><span class="p">).</span><span class="nf">pretty</span>
    <span class="n">timestamp</span><span class="o">=</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">to_i</span><span class="p">.</span><span class="nf">to_s</span>    
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"timbrado_request_</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.xml"</span> <span class="p">,</span><span class="s2">"w"</span><span class="p">){</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span><span class="n">file</span><span class="p">.</span><span class="nf">puts</span> <span class="n">request</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">:get_cfdi</span><span class="p">,</span> <span class="n">message</span><span class="ss">:soapParams</span><span class="p">)</span>
    <span class="c1"># print response.to_xml</span>
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"timbrado_response_</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.xml"</span> <span class="p">,</span><span class="s2">"w"</span><span class="p">){</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span><span class="n">file</span><span class="p">.</span><span class="nf">puts</span> <span class="n">response</span><span class="p">.</span><span class="nf">to_xml</span><span class="p">}</span>
    <span class="nb">puts</span> <span class="s2">"Escribiendo zip"</span>
    <span class="n">zipName</span><span class="o">=</span><span class="s2">"zip_timbrado_</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.zip"</span>
    <span class="c1">#se decodifica el resultado de la respuesta(base64) y se escribe a un archivo zip que contiene el xml timbrado</span>
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">zipName</span> <span class="p">,</span><span class="s2">"w"</span><span class="p">){</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span><span class="n">file</span><span class="p">.</span><span class="nf">puts</span> <span class="no">Base64</span><span class="p">.</span><span class="nf">strict_decode64</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">[</span><span class="ss">:get_cfdi_response</span><span class="p">][</span><span class="ss">:return</span><span class="p">])}</span>


    <span class="c1">#una vez escrito el zip, debemos extraer el XML timbrado</span>
    <span class="no">Zip</span><span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">zipName</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">zipfile</span><span class="o">|</span>
        <span class="n">zipfile</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
          <span class="c1"># do something with file</span>
          <span class="n">file</span><span class="p">.</span><span class="nf">extract</span>
        <span class="k">end</span>
      <span class="k">end</span>
<span class="k">rescue</span> <span class="no">Savon</span><span class="o">::</span><span class="no">SOAPFault</span> <span class="o">=&gt;</span> <span class="n">e</span>  
    <span class="c1">#print client.request</span>
    <span class="nb">puts</span> <span class="s2">"Exception:"</span>
    <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span>    
    <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">http</span><span class="p">.</span><span class="nf">code</span>    
    <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">to_hash</span><span class="c1">#[':fault']#[':faultcode']    </span>
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"timbrado_response_</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.xml"</span> <span class="p">,</span><span class="s2">"w"</span><span class="p">){</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span><span class="n">file</span><span class="p">.</span><span class="nf">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">http</span><span class="p">.</span><span class="nf">body</span><span class="p">}</span>

   <span class="c1"># print e.backtrace</span>

    <span class="c1">#print e.as_json</span>
<span class="k">end</span>
</code></pre><pre class="highlight python tab-python"><code> <span class="c">#Ejemplo de ws de timbrado getCFDI(). Para timbrado masivo(con miles de conceptos enviar a )</span>
<span class="c">#Para usar este ejemplo debes instalar Zeep mediante pip</span>
<span class="c">#Comando</span>
<span class="c">#&gt;pip install zeep</span>

<span class="kn">from</span> <span class="nn">zeep</span> <span class="kn">import</span> <span class="n">Client</span> <span class="c">#En este caso de utiliza la libreria Zeep para clientes SOAP. Puede utilizar la libreria de su eleccion</span>
<span class="kn">from</span> <span class="nn">zeep.exceptions</span> <span class="kn">import</span> <span class="n">Fault</span>
<span class="kn">from</span> <span class="nn">zeep.plugins</span> <span class="kn">import</span> <span class="n">HistoryPlugin</span> <span class="c"># con este plugin puedes obtener el historico de peticiones y respuestas</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span><span class="p">;</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span> <span class="c">#necesario para extraer el zip donde viene el XML timbrado</span>

<span class="c">#Para evitar colocar accesos directamente en codigo se lee de un archivo.</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">'config.ini'</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="s">"Archivo de configuracion no existe"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>      
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s">'config.ini'</span><span class="p">)</span>

    <span class="n">usuario</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'timbrado'</span><span class="p">][</span><span class="s">'UsuarioSIFEI'</span><span class="p">]</span><span class="c">#"Usuario SIFEI"</span>
    <span class="n">password</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'timbrado'</span><span class="p">][</span><span class="s">'PasswordSIFEI'</span><span class="p">]</span><span class="c"># "Password SIFEI"</span>
    <span class="n">idEquipo</span> <span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s">'timbrado'</span><span class="p">][</span><span class="s">'IdEquipoGenerado'</span><span class="p">]</span><span class="c"># "ID de Equipo SIFEI"</span>

    <span class="c">#directorio relativo a este script compatible con windows y linux(para luego generar el path para leer el XML sellado)</span>
    <span class="n">xmlDIR</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">workDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">timestamp</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c">#Para este ejmplo se envia a timbrar un XML ya sellado  desde una ruta:</span>
        <span class="n">xml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xmlDIR</span><span class="p">,</span><span class="s">"assets/CFDI33_sellado.xml"</span><span class="p">)</span>
        <span class="n">zipPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xmlDIR</span><span class="p">,</span><span class="s">"assets/CFDI33_timbrado.zip"</span><span class="p">)</span>
        <span class="n">destino_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xmlDIR</span><span class="p">,</span><span class="s">"assets/"</span><span class="p">)</span>

        <span class="n">serie</span> <span class="o">=</span> <span class="s">""</span> <span class="c">#Serie vacia para usuarios de timbrado    </span>

        <span class="c">#Se lee el archivo xml establecido en la variable xml_path</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">xml_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
        <span class="n">readxml</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c">#Se transforma el xml en array de bytes</span>
        <span class="n">xml_bytesArray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">readxml</span><span class="p">,</span><span class="s">'utf-8'</span><span class="p">)</span>
        <span class="c">#Se crea history para cliente SOAP</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">HistoryPlugin</span><span class="p">()</span>
        <span class="c">#Se establece el cliente SOAP mediante la clase 'Cliente' de Zeep</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span>
            <span class="n">wsdl</span><span class="o">=</span><span class="s">"http://devcfdi.sifei.com.mx:8080/SIFEI33/SIFEI?wsdl"</span><span class="p">,</span>
            <span class="n">plugins</span><span class="o">=</span><span class="p">[</span><span class="n">history</span><span class="p">]</span>  <span class="c">#Plugin para guardar el request y response para la fase de intregracion(podras ver alli los errores arrojados)</span>
        <span class="p">)</span>
        <span class="c">#Se pasan los parametros requeridos para el metodo de timbrado getCFDI()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">getCFDI</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">xml_bytesArray</span><span class="p">,</span> <span class="n">serie</span><span class="p">,</span> <span class="n">idEquipo</span><span class="p">)</span>
        <span class="c">#Se recibe el xml en caso de ser timbrado(viene dentro de un zip)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">zipPath</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedWriter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c">#una vez escrito el zip, debemos extraer el XML timbrado</span>
            <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">zipPath</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipObj</span><span class="p">:</span>
                <span class="n">zipObj</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">destino_path</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="s">"Comprobante almacenado en su sistema."</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">Fault</span> <span class="k">as</span> <span class="n">fault</span><span class="p">:</span>
        <span class="c">#Se extrae el request en caso de excepcion</span>
        <span class="n">detail_decoded</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">wsdl</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">detail</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c">#    timbrado = detail_decoded.xml        #Para extraer xml timbrado en caso de utilizar el metodo getCFDISign()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">detail_decoded</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
         <span class="c">#En ambiente de pruebas mandamos el requets y response  a un archivo respecticamente para inspeccionarlos en caso de error, se asigna un timestamp para identificarlos:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workDir</span><span class="p">,</span><span class="s">"timbrado_request_"</span><span class="o">+</span><span class="n">timestamp</span><span class="o">+</span><span class="s">".xml"</span><span class="p">),</span><span class="s">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">last_sent</span><span class="p">[</span><span class="s">"envelope"</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"unicode"</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workDir</span><span class="p">,</span><span class="s">"timbrado_response_"</span><span class="o">+</span><span class="n">timestamp</span><span class="o">+</span><span class="s">".xml"</span><span class="p">),</span><span class="s">'w'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">last_received</span><span class="p">[</span><span class="s">"envelope"</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"unicode"</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span> 



</code></pre><pre class="highlight php tab-php"><code><span class="cp">&lt;?php</span>
<span class="sd">/**
 * Ejemplo de timbrado PHP del WS SOAP getCFDI() de SIFEI. * 
 * 
 * El CFDI(XML) debe estar sellado correctamente
 * Nota: Para simplificar los ejemplos todas las rutas son relativas y los datos se leen de un archivo config.ini, lo cual no debe de hacerse en un ambiente de produccion.
 * 
 */</span>
<span class="nv">$cfdiSelladoPath</span><span class="o">=</span><span class="nx">__DIR__</span><span class="o">.</span><span class="s2">"/assets/cfdi.xml"</span><span class="p">;</span><span class="c1">//Ruta del xml sellado
</span><span class="nv">$originalName</span><span class="o">=</span><span class="nb">basename</span><span class="p">(</span><span class="nv">$cfdiSelladoPath</span><span class="p">);</span>
<span class="c1">#Se lee el contenido del XML
</span><span class="nv">$xml</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$cfdiSelladoPath</span><span class="p">);</span>
<span class="nv">$tmpDirName</span> <span class="o">=</span> <span class="s2">"tmp"</span><span class="p">;</span> <span class="c1">//nombre del directorio temporal
//Para el atributo archivoXMLZip no es necesario aplicar el base64_encode ya que la misma libreria SoapClient lo hace, por eso la mandamos tal cual.
</span>
<span class="nv">$array_ini</span> <span class="o">=</span><span class="nb">parse_ini_file</span><span class="p">(</span><span class="nx">__DIR__</span><span class="o">.</span><span class="s2">"/config.ini"</span><span class="p">);</span>
<span class="nv">$parametros</span><span class="o">=</span><span class="k">array</span><span class="p">(</span>
    <span class="c1">//accesos
</span>    <span class="s1">'Usuario'</span><span class="o">=&gt;</span><span class="nv">$array_ini</span><span class="p">[</span><span class="s1">'UsuarioSIFEI'</span><span class="p">],</span> 
    <span class="s1">'Password'</span><span class="o">=&gt;</span><span class="nv">$array_ini</span><span class="p">[</span><span class="s1">'PasswordSIFEI'</span><span class="p">],</span>
    <span class="s1">'IdEquipo'</span><span class="o">=&gt;</span><span class="nv">$array_ini</span><span class="p">[</span><span class="s1">'IdEquipoGenerado'</span><span class="p">],</span>
    <span class="c1">//archivo XML
</span>    <span class="s1">'archivoXMLZip'</span><span class="o">=&gt;</span><span class="nv">$xml</span><span class="p">,</span>  
    <span class="s1">'Serie'</span><span class="o">=&gt;</span><span class="s1">''</span>

<span class="p">);</span>

<span class="c1">//url de pruebas
</span><span class="nv">$wsdl</span> <span class="o">=</span><span class="s2">"http://devcfdi.sifei.com.mx:8080/SIFEI33/SIFEI?wsdl"</span><span class="p">;</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SoapClient</span><span class="p">(</span><span class="nv">$wsdl</span><span class="p">,</span> 
    <span class="k">array</span><span class="p">(</span>
        <span class="s1">'soap_version'</span> <span class="o">=&gt;</span> <span class="nx">SOAP_1_1</span><span class="p">,</span>
        <span class="s1">'trace'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">);</span> 

<span class="k">try</span> <span class="p">{</span>
    <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">__soapCall</span><span class="p">(</span><span class="s1">'getCFDI'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$parametros</span> <span class="p">));</span>
    <span class="nv">$fileTmpZip</span> <span class="o">=</span> <span class="s2">"timbrado.zip"</span><span class="p">;</span>  <span class="c1">//nombre del zip
</span>    <span class="c1">//mandamos en un zip el xml timbrado en caso de exito
</span>    <span class="nb">file_put_contents</span><span class="p">(</span> <span class="nv">$fileTmpZip</span><span class="p">,</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">return</span><span class="p">);</span>
    <span class="nv">$zipXml</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZipArchive</span><span class="p">();</span><span class="c1">//En caso de not found ZipArchive, asegurate de tener instalada la extension
</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$zipXml</span><span class="o">-&gt;</span><span class="na">open</span><span class="p">(</span><span class="nv">$fileTmpZip</span><span class="p">)</span> <span class="o">===</span> <span class="k">TRUE</span><span class="p">)</span> <span class="p">{</span>          
        <span class="nv">$zipXml</span><span class="o">-&gt;</span><span class="na">extractTo</span><span class="p">(</span> <span class="nv">$tmpDirName</span> <span class="p">);</span>
        <span class="nv">$zipXml</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>


<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">SoapFault</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">#En caso de un error inspeccionar la excepcion:
</span>    <span class="nb">var_dump</span><span class="p">(</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">faultcode</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">faultstring</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">detail</span> <span class="p">);</span>
<span class="p">}</span> <span class="nx">finally</span><span class="p">{</span>
    <span class="nv">$time</span><span class="o">=</span><span class="nb">time</span><span class="p">();</span>
    <span class="c1">#En ambiente de pruebas mandamos el requets y response  a un archivo respecticamente para inspeccionarlos en caso de error, se asigna un timestamp para identificarlos:
</span>    <span class="c1">//mandamos en un XML el mensaje soap del request
</span>

    <span class="nv">$doc</span><span class="o">=</span><span class="k">new</span> <span class="nx">DOMDocument</span><span class="p">();</span>
    <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">loadXML</span><span class="p">(</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">__getLastRequest</span><span class="p">());</span>
    <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">formatOutput</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>
    <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nx">__DIR__</span><span class="o">.</span><span class="s2">"/workfiles/timbrado_getCFDI_request_</span><span class="si">{</span><span class="nv">$time</span><span class="si">}</span><span class="s2">.xml"</span><span class="p">);</span>

    <span class="c1">//mandamos en un XML el response del xml timbrado
</span>
    <span class="nv">$doc</span><span class="o">=</span><span class="k">new</span> <span class="nx">DOMDocument</span><span class="p">();</span>
    <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">loadXML</span><span class="p">(</span><span class="nv">$client</span><span class="o">-&gt;</span><span class="na">__getLastResponse</span><span class="p">());</span>
    <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">formatOutput</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>
    <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nx">__DIR__</span><span class="o">.</span><span class="s2">"/workfiles/timbrado_getCFDI_response_</span><span class="si">{</span><span class="nv">$time</span><span class="si">}</span><span class="s2">.xml"</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre><pre class="highlight javascript tab-javascript"><code><span class="cm">/**
 * Ejemplo de timbrado PHP del WS SOAP getCFDI() de SIFEI. * 
 * 
 * El CFDI(XML) debe estar sellado correctamente
 * Nota: Para simplificar los ejemplos todas las rutas son relativas y los datos se leen de un archivo config.ini, lo cual no debe de hacerse en un ambiente de produccion.
 * Los datos de pruebas y produccion son distintos, deberas solicitar primero tus datos de pruebas y una vez finalizadas tus pruebas deberas reemplazar tus accesos y URL de Ws service.
 */</span>
<span class="kd">var</span> <span class="nx">soap</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'soap'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ini</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'ini'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">unzipper</span><span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'unzipper'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">);</span>


<span class="c1">//cargamos los accesos desde un almacenamiento seguro, en este caso para facilitar el ejemplo se lee desde un archivo .ini</span>
<span class="kd">var</span> <span class="nx">config</span><span class="o">=</span><span class="nx">ini</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'./config.ini'</span><span class="p">,</span><span class="s1">'utf-8'</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">usuario</span><span class="o">=</span><span class="nx">config</span><span class="p">.</span><span class="nx">timbrado</span><span class="p">.</span><span class="nx">UsuarioSIFEI</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">password</span><span class="o">=</span><span class="nx">config</span><span class="p">.</span><span class="nx">timbrado</span><span class="p">.</span><span class="nx">PasswordSIFEI</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">idEquipo</span><span class="o">=</span><span class="nx">config</span><span class="p">.</span><span class="nx">timbrado</span><span class="p">.</span><span class="nx">IdEquipoGenerado</span><span class="p">;</span>



<span class="c1">//leemos el XML desde un archivo local,nota, la library propuesta no detecta que tipo requerido para archivoXMLZip es un binario y no lo codifica a base 64 </span>
<span class="c1">//por lo que se debe de realizar</span>
<span class="nx">cfdi</span><span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'./assets/cfdi.xml'</span><span class="p">,</span><span class="s1">'utf-8'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">cfdiBase64</span><span class="o">=</span><span class="p">(</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">cfdi</span><span class="p">,</span><span class="s1">'utf-8'</span><span class="p">)).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">);</span>
<span class="c1">//console.log(cfdi)</span>
<span class="c1">//URL de pruebas</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">'http://devcfdi.sifei.com.mx:8080/SIFEI33/SIFEI?wsdl'</span><span class="p">;</span>

<span class="c1">//preparamos los parametros de timbrado</span>
<span class="kd">var</span> <span class="nx">parametrosDeTimbrado</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">Usuario</span><span class="p">:</span> <span class="nx">usuario</span><span class="p">,</span>   <span class="c1">//usuario de sifei</span>
    <span class="na">Password</span><span class="p">:</span><span class="nx">password</span> <span class="p">,</span> <span class="c1">//contrase帽a</span>
    <span class="na">IdEquipo</span><span class="p">:</span> <span class="nx">idEquipo</span><span class="p">,</span> <span class="c1">//id de equipo</span>
    <span class="na">archivoXMLZip</span><span class="p">:</span> <span class="nx">cfdiBase64</span><span class="p">,</span> <span class="c1">//archivo CFDI</span>
    <span class="na">Serie</span><span class="p">:</span><span class="s2">""</span> <span class="p">,</span>
<span class="p">};</span>
<span class="nx">soap</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>

   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">describe</span><span class="p">()))</span><span class="c1">//con esta linea averguaguamos los metodos</span>
    <span class="c1">//invamos metodo de timbrado:</span>
   <span class="nx">client</span><span class="p">.</span><span class="nx">getCFDI</span><span class="p">(</span><span class="nx">parametrosDeTimbrado</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">rawSoapResponse</span><span class="p">,</span><span class="nx">soapResponseHeader</span><span class="p">,</span><span class="nx">rawSoapRequest</span><span class="p">){</span>
        <span class="c1">//#En ambiente de pruebas mandamos el requets y response  a un archivo respecticamente para inspeccionarlos en caso de error, se asigna un timestamp para identificarlos:</span>
        <span class="kd">let</span> <span class="nx">timestamp</span><span class="o">=</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="s2">`./tmp/timbrado_response_</span><span class="p">${</span><span class="nx">timestamp</span><span class="p">}</span><span class="s2">.xml`</span><span class="p">,</span><span class="nx">rawSoapResponse</span><span class="p">)</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="s2">`./tmp/timbrado_request_</span><span class="p">${</span><span class="nx">timestamp</span><span class="p">}</span><span class="s2">.xml`</span><span class="p">,</span><span class="nx">rawSoapRequest</span><span class="p">)</span>

        <span class="c1">//ahora continuamos con el flujo normal</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
           <span class="c1">//ocurrio un error , se debe leer la excepcion de sifei para ver cual es el error en el XML            </span>
           <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"error"</span><span class="p">)</span>
           <span class="c1">//mensaje de error</span>
           <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
           <span class="c1">//excepcion completa(es un JSON tranformado):</span>
            <span class="cm">/**
             * {
                    codigo: 'XX',
                    error: 'XXXX',
                    message: 'XXXX'
                }
             */</span>
           <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">Envelope</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">Fault</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">SifeiException</span><span class="p">)</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">"ok"</span><span class="p">)</span>
           <span class="c1">//Podemos extraer el cfdi timbrado  (viene dentro de un zip) </span>
          <span class="c1">// console.log(res)</span>
            <span class="kd">let</span> <span class="nx">zipP</span><span class="o">=</span><span class="s1">'./tmp/timbrado.zip'</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">timbradoDir</span><span class="o">=</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">zipP</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">sep</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span>
            <span class="c1">//la respuesta vieene en el return</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">zipP</span><span class="p">,</span><span class="nx">res</span><span class="p">.</span><span class="k">return</span><span class="p">,{</span>
              <span class="na">encoding</span><span class="p">:</span><span class="s1">'base64'</span>  
            <span class="p">})</span>  
            <span class="c1">//ahora debemos leer el zip y extraer los archivos(solo es el XML timbrado)</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">zipP</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">unzipper</span><span class="p">.</span><span class="nx">Extract</span><span class="p">({</span>
                    <span class="na">path</span><span class="p">:</span><span class="nx">timbradoDir</span>
                <span class="p">}))</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Archivos extraidos"</span><span class="p">)</span>
        <span class="p">}</span>
   <span class="p">})</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>Solictud generada:</p>
</blockquote>
<pre class="highlight xml tab-xml"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;env:Envelope</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xmlns:tns=</span><span class="s">"http://MApeados/"</span> <span class="na">xmlns:env=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env:Body&gt;</span>
    <span class="nt">&lt;tns:getCFDI&gt;</span>
      <span class="nt">&lt;Usuario&gt;</span>TCM....<span class="nt">&lt;/Usuario&gt;</span>
      <span class="nt">&lt;Password&gt;</span>123456..<span class="nt">&lt;/Password&gt;</span>
      <span class="nt">&lt;IdEquipo&gt;</span>123dsa..<span class="nt">&lt;/IdEquipo&gt;</span>
      <span class="nt">&lt;archivoXMLZip&gt;</span>PD94bWwgd..<span class="nt">&lt;/archivoXMLZip&gt;</span>
      <span class="nt">&lt;Serie/&gt;</span>
    <span class="nt">&lt;/tns:getCFDI&gt;</span>
  <span class="nt">&lt;/env:Body&gt;</span>
<span class="nt">&lt;/env:Envelope&gt;</span>

</code></pre>
<blockquote>
<p>Respuesta retornada:</p>
</blockquote>
<pre class="highlight xml tab-xml"><code><span class="cp">&lt;?xml version='1.0' encoding='UTF-8'?&gt;</span>
<span class="nt">&lt;S:Envelope</span> <span class="na">xmlns:S=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;&lt;S:Body&gt;</span>
<span class="nt">&lt;ns2:getCFDIResponse</span> <span class="na">xmlns:ns2=</span><span class="s">"http://MApeados/"</span><span class="nt">&gt;</span>
<span class="nt">&lt;return&gt;</span>UEsDBBQACAAIAI5...<span class="nt">&lt;/return&gt;</span>
<span class="nt">&lt;/ns2:getCFDIResponse&gt;&lt;/S:Body&gt;</span>
<span class="nt">&lt;/S:Envelope&gt;</span>
</code></pre>
<p>Este metodo se encarga de timbrar un CFDI, por tanto es el metodo mas importante.</p>

<p class="light"></p>
<pre class="highlight xml tab-xml"><code><span class="cp">&lt;?xml version='1.0' encoding='UTF-8'?&gt;</span>
<span class="nt">&lt;S:Envelope</span> <span class="na">xmlns:S=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;&lt;S:Body&gt;</span>
<span class="nt">&lt;ns2:getCFDIResponse</span> <span class="na">xmlns:ns2=</span><span class="s">"http://MApeados/"</span><span class="nt">&gt;</span>
<span class="nt">&lt;return&gt;</span>UEsDBBQACAAIAI5...<span class="nt">&lt;/return&gt;</span>
<span class="nt">&lt;/ns2:getCFDIResponse&gt;&lt;/S:Body&gt;</span>
<span class="nt">&lt;/S:Envelope&gt;</span>
</code></pre><h3 id='url-de-timbrado'>URL de timbrado</h3>
<p>La siguiente es la URL de pruebas, con ella podras consumir y acceder a todos los metodos disponibles</p>

<p><code>http://devcfdi.sifei.com.mx:8080/SIFEI33/SIFEI</code></p>
<h3 id='parametros-de-la-solicitud'>Parametros de la solicitud</h3>
<p>A continuacion se muestran los parametros necesarios para consumir el ws</p>

<table><thead>
<tr>
<th>Parametro</th>
<th>Tipo</th>
<th>Descripcion</th>
</tr>
</thead><tbody>
<tr>
<td>Usuario</td>
<td>String</td>
<td>Usuario sifei</td>
</tr>
<tr>
<td>Password</td>
<td>String</td>
<td>If setset to false, the result will include kittens that have already been adopted.</td>
</tr>
<tr>
<td>IdEquipo</td>
<td>String</td>
<td>If setset to false, the result will include kittens that have already been adopted.</td>
</tr>
<tr>
<td>archivoXMLZip</td>
<td>Binario(base64)</td>
<td>XML a timbrar</td>
</tr>
<tr>
<td>Serie</td>
<td>Binario(base64)</td>
<td>XML a timbrar</td>
</tr>
</tbody></table>

<aside class="success">
Recuerda solicitar tus accesos para poder realizar tus pruebas!
</aside>

<aside class="notice">
 Anteriormente el servicio requier铆a que el XML estuviera dentro de un archivo zip
</aside>
<h3 id='excepcion'>Excepci贸n</h3>
<p>Cuando se produce un error en el servicio la respuesta SOAP genera una excepcion llamada SifeiException:</p>

<p class="light"></p>
<pre class="highlight xml tab-xml"><code><span class="cp">&lt;?xml version='1.0' encoding='UTF-8'?&gt;</span>
<span class="nt">&lt;S:Envelope</span> <span class="na">xmlns:S=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;</span>
<span class="nt">&lt;S:Body&gt;</span>
<span class="nt">&lt;S:Fault</span> <span class="na">xmlns:ns4=</span><span class="s">"http://www.w3.org/2003/05/soap-envelope"</span><span class="nt">&gt;</span>
<span class="nt">&lt;faultcode&gt;</span>S:Server<span class="nt">&lt;/faultcode&gt;</span>
<span class="nt">&lt;faultstring&gt;</span>Par谩metros incompletos<span class="nt">&lt;/faultstring&gt;</span>
<span class="nt">&lt;detail&gt;</span>
<span class="nt">&lt;ns2:SifeiException</span> <span class="na">xmlns:ns2=</span><span class="s">"http://service.sifei.cancelacion/"</span><span class="nt">&gt;</span>
<span class="nt">&lt;codigo&gt;</span>1003<span class="nt">&lt;/codigo&gt;</span>
<span class="nt">&lt;detalle&gt;</span>Par谩metros incompletos<span class="nt">&lt;/detalle&gt;</span>
<span class="nt">&lt;error&gt;</span>Par谩metros incompletos<span class="nt">&lt;/error&gt;</span>
<span class="nt">&lt;/ns2:SifeiException&gt;</span>
<span class="nt">&lt;/detail&gt;</span>
<span class="nt">&lt;/S:Fault&gt;</span>
<span class="nt">&lt;/S:Body&gt;</span>
<span class="nt">&lt;/S:Envelope&gt;</span>
</code></pre><h3 id='codigos-de-error'>Codigos de error</h3>
<p>Es importante mencionar ...</p>

<table><thead>
<tr>
<th>Codigo de error</th>
<th>Significado</th>
</tr>
</thead><tbody>
<tr>
<td>400</td>
<td>Bad Request -- Your request is invalid.</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized -- Your API key is wrong.</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden -- The kitten requested is hidden for administrators only.</td>
</tr>
<tr>
<td>404</td>
<td>Not Found -- The specified kitten could not be found.</td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allowed -- You tried to access a kitten with an invalid method.</td>
</tr>
<tr>
<td>406</td>
<td>Not Acceptable -- You requested a format that isn&#39;t json.</td>
</tr>
<tr>
<td>410</td>
<td>Gone -- The kitten requested has been removed from our servers.</td>
</tr>
<tr>
<td>418</td>
<td>I&#39;m a teapot.</td>
</tr>
<tr>
<td>429</td>
<td>Too Many Requests -- You&#39;re requesting too many kittens! Slow down!</td>
</tr>
<tr>
<td>500</td>
<td>Internal Server Error -- We had a problem with our server. Try again later.</td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable -- We&#39;re temporarily offline for maintenance. Please try again later.</td>
</tr>
</tbody></table>
<h1 id='cancelacion'>Cancelacion</h1><h2 id='cancelar-cfdi-cancelacfdi'>Cancelar CFDI (cancelaCFDI):</h2>
<p>Contenido</p>
<pre class="highlight php tab-php"><code><span class="cp">&lt;?php</span>
<span class="sd">/**
* Ejemplo de cancelacion WS SOAP cancelaCFDI()
* Nota: Para simplificar los ejemplos todas las rutas son relativas y los datos se leen de un archivo, lo cual no debe de hacerse en un ambiente de produccion.
* # PFX CONFORMADO POR key y cert
*/</span>
<span class="nv">$array_ini</span> <span class="o">=</span><span class="nb">parse_ini_file</span><span class="p">(</span><span class="nx">__DIR__</span><span class="o">.</span><span class="s2">"/config.ini"</span><span class="p">);</span>

<span class="c1">#Parametros requeridos para consumir el metodo de cancelaci贸n
</span><span class="nv">$usuarioSIFEI</span> <span class="o">=</span> <span class="nv">$array_ini</span><span class="p">[</span><span class="s1">'UsuarioSIFEI'</span><span class="p">];</span><span class="c1">//;"usuario SIFEI";
</span><span class="nv">$passwordSifei</span> <span class="o">=</span><span class="nv">$array_ini</span><span class="p">[</span><span class="s1">'PasswordSIFEI'</span><span class="p">];</span> <span class="c1">//"password SIFEI";
</span>
<span class="nv">$rfcEmisor</span> <span class="o">=</span> <span class="s2">"RFC del emisor"</span><span class="p">;</span>
<span class="nv">$pfx</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nx">__DIR__</span><span class="o">.</span><span class="s2">"/"</span><span class="o">.</span><span class="nv">$array_ini</span><span class="p">[</span><span class="s2">"PFX"</span><span class="p">]);</span> <span class="c1">#se lee el contenido del PFX, solo como ejemplo se lee de un directorio
</span><span class="nv">$passwordPfx</span> <span class="o">=</span><span class="s2">"a0123456789"</span><span class="p">;</span> <span class="c1">#"contrase帽a del pfx";
</span><span class="nv">$uuids</span><span class="p">[]</span><span class="o">=</span> <span class="s2">"uuid"</span><span class="p">;</span>
<span class="c1">//Para el atributo pfx no es necesario aplicar el base64_encode ya que SoapClient se encarga de realizarlo.
</span><span class="nv">$parametros</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'usuarioSIFEI'</span><span class="o">=&gt;</span><span class="nv">$usuarioSIFEI</span><span class="p">,</span>
    <span class="s1">'passwordSifei'</span><span class="o">=&gt;</span><span class="nv">$passwordSifei</span><span class="p">,</span>
    <span class="s1">'rfcEmisor'</span><span class="o">=&gt;</span><span class="nv">$rfcEmisor</span><span class="p">,</span> 
    <span class="s1">'pfx'</span><span class="o">=&gt;</span><span class="nv">$pfx</span><span class="p">,</span> 
    <span class="s1">'passwordPfx'</span><span class="o">=&gt;</span><span class="nv">$passwordPfx</span><span class="p">,</span>
    <span class="s2">"uuids"</span><span class="o">=&gt;</span><span class="nv">$uuids</span>
<span class="p">);</span>
<span class="c1">#print_r($parametros);
//url de pruebas
</span><span class="nv">$wsdl</span> <span class="o">=</span><span class="s2">"http://devcfdi.sifei.com.mx:8888/CancelacionSIFEI/Cancelacion?wsdl"</span><span class="p">;</span>

<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SoapClient</span><span class="p">(</span><span class="nv">$wsdl</span><span class="p">,</span> 
                <span class="k">array</span><span class="p">(</span>  
                <span class="s1">'soap_version'</span> <span class="o">=&gt;</span> <span class="nx">SOAP_1_1</span><span class="p">,</span>
                <span class="s1">'trace'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">));</span> 


<span class="k">try</span> <span class="p">{</span>
    <span class="nv">$res</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">__soapCall</span><span class="p">(</span> <span class="s1">'cancelaCFDI'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$parametros</span> <span class="p">));</span>

    <span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">"acuse.xml"</span><span class="p">,</span> <span class="nv">$res</span><span class="o">-&gt;</span><span class="na">return</span> <span class="p">);</span>
    <span class="k">echo</span> <span class="s2">"Se guardo acuse"</span><span class="p">;</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">SoapFault</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span> 
    <span class="c1">#obtenemos la excepcion:
</span>    <span class="nb">var_dump</span><span class="p">(</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">faultcode</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">faultstring</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">detail</span> <span class="p">);</span>
<span class="p">}</span> <span class="nx">finally</span><span class="p">{</span>
    <span class="nv">$time</span><span class="o">=</span><span class="nb">time</span><span class="p">();</span>
    <span class="c1">#En ambiente de pruebas mandamos el requets y response  a un archivo respecticamente para inspeccionarlos en caso de error, se asigna un timestamp para identificarlos:
</span>    <span class="c1">//mandamos en un XML el mensaje soap del request
</span>    <span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">"cancelaCFDI_request_</span><span class="si">{</span><span class="nv">$time</span><span class="si">}</span><span class="s2">.xml"</span><span class="p">,</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">__getLastRequest</span><span class="p">());</span>
    <span class="c1">//mandamos en un XML el response del xml timbrado
</span>    <span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">"cancelaCFDI_response_</span><span class="si">{</span><span class="nv">$time</span><span class="si">}</span><span class="s2">.xml"</span><span class="p">,</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">__getLastResponse</span><span class="p">());</span>    
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre><pre class="highlight ruby tab-ruby"><code><span class="c1">#Requiere isntalar la gema savon</span>

<span class="c1">#gem install savon</span>
<span class="c1">#gem install iniparse</span>
<span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'savon'</span>
<span class="nb">require</span> <span class="s1">'iniparse'</span>
<span class="nb">require</span> <span class="s1">'time'</span>
<span class="nb">require</span> <span class="s2">"base64"</span>

<span class="n">config</span><span class="o">=</span><span class="no">IniParse</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'config.ini'</span><span class="p">)</span> <span class="p">)</span>

<span class="nb">print</span> <span class="n">config</span>
<span class="nb">print</span> <span class="s2">"hel"</span>

<span class="n">usuario</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">'timbrado'</span><span class="p">][</span><span class="s1">'UsuarioSIFEI'</span><span class="p">]</span>
<span class="n">password</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">'timbrado'</span><span class="p">][</span><span class="s1">'PasswordSIFEI'</span><span class="p">]</span>
<span class="n">idEquipo</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">'timbrado'</span><span class="p">][</span><span class="s1">'IdEquipoGenerado'</span><span class="p">]</span>
<span class="n">pfxPath</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">'timbrado'</span><span class="p">][</span><span class="s1">'PFX'</span><span class="p">]</span>

<span class="c1">#file=File.open('xml_sellado.xml','r');</span>
<span class="c1">#cfdi_contenido=file.read</span>
<span class="n">pfx</span><span class="o">=</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">pfxPath</span><span class="p">)</span>

<span class="c1">#savon 2 no ofrece una manera directa de acceder al request por lo que deberas de utilizar algun interceptor</span>
<span class="n">client</span> <span class="o">=</span> <span class="no">Savon</span><span class="p">.</span><span class="nf">client</span><span class="p">(</span><span class="ss">wsdl: </span><span class="s1">'http://devcfdi.sifei.com.mx:8888/CancelacionSIFEI/Cancelacion?wsdl'</span><span class="p">,</span>
    <span class="c1">#log: true</span>
    <span class="p">)</span>
    <span class="n">passwordPfx</span> <span class="o">=</span><span class="s2">"a0123456789"</span>
<span class="c1">#print client.operations</span>
<span class="k">begin</span>
    <span class="c1">#Establecemos el hash(dictionario) con los datos a utilizar!</span>
    <span class="n">soapParams</span><span class="o">=</span> <span class="p">{</span> 
        <span class="ss">usuarioSIFEI: </span><span class="n">usuario</span><span class="p">,</span>
        <span class="n">passwordSifei</span><span class="ss">:password</span> <span class="p">,</span>
        <span class="ss">rfcEmisor: </span><span class="s1">'RFC'</span><span class="p">,</span>
        <span class="ss">pfx: </span><span class="no">Base64</span><span class="p">.</span><span class="nf">encode64</span><span class="p">(</span><span class="n">pfx</span><span class="p">),</span> <span class="c1"># PFX CONFORMADO POR key y cert</span>
        <span class="ss">passwordPfx: </span><span class="n">passwordPfx</span><span class="p">,</span> <span class="c1">#         </span>
        <span class="n">uuids</span><span class="ss">:'uuids'</span>
    <span class="p">}</span>

    <span class="nb">print</span> <span class="n">soapParams</span>
    <span class="c1">#simulamos </span>
    <span class="n">operation</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="nf">operation</span><span class="p">(</span><span class="ss">:cancela_cfdi</span><span class="p">)</span>
    <span class="n">request</span><span class="o">=</span> <span class="n">operation</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">message</span><span class="ss">:soapParams</span><span class="p">).</span><span class="nf">pretty</span>
    <span class="n">timestamp</span><span class="o">=</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">to_i</span><span class="p">.</span><span class="nf">to_s</span>    
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"cancelacion_request_</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.xml"</span> <span class="p">,</span><span class="s2">"w"</span><span class="p">){</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span><span class="n">file</span><span class="p">.</span><span class="nf">puts</span> <span class="n">request</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">:cancela_cfdi</span><span class="p">,</span> <span class="n">message</span><span class="ss">:soapParams</span><span class="p">)</span>
    <span class="c1"># print response.to_xml</span>
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"cancelacion_response_</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.xml"</span> <span class="p">,</span><span class="s2">"w"</span><span class="p">){</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span><span class="n">file</span><span class="p">.</span><span class="nf">puts</span> <span class="n">response</span><span class="p">.</span><span class="nf">to_xml</span><span class="p">}</span>
    <span class="nb">puts</span> <span class="s2">"Acuse"</span>
    <span class="c1">#puts response.body</span>
    <span class="nb">puts</span> <span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">[</span><span class="ss">:cancela_cfdi_response</span><span class="p">][</span><span class="ss">:return</span><span class="p">];</span>
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"cancelacion_acuse_</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.xml"</span> <span class="p">,</span><span class="s2">"w"</span><span class="p">){</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span><span class="n">file</span><span class="p">.</span><span class="nf">puts</span> <span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">[</span><span class="ss">:cancela_cfdi_response</span><span class="p">][</span><span class="ss">:return</span><span class="p">]}</span>

<span class="k">rescue</span> <span class="no">Savon</span><span class="o">::</span><span class="no">SOAPFault</span> <span class="o">=&gt;</span> <span class="n">e</span>  
    <span class="c1">#print client.request</span>
    <span class="nb">puts</span> <span class="s2">"Exception:"</span>
    <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span>    
    <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">http</span><span class="p">.</span><span class="nf">code</span>    
    <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">to_hash</span><span class="c1">#[':fault']#[':faultcode']    </span>
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"cancelacion_response_</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.xml"</span> <span class="p">,</span><span class="s2">"w"</span><span class="p">){</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span><span class="n">file</span><span class="p">.</span><span class="nf">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">http</span><span class="p">.</span><span class="nf">body</span><span class="p">}</span>

   <span class="c1"># print e.backtrace</span>

    <span class="c1">#print e.as_json</span>
<span class="k">end</span>

</code></pre><h2 id='getcfdiprocesa'>getCFDIProcesa</h2>
<p>contenido</p>
<h2 id='codigos-de-error'>codigos de error</h2>
      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="php">php</a>
                <a href="#" data-language-name="ruby">ruby</a>
                <a href="#" data-language-name="python">python</a>
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
